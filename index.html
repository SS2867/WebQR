<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>二维码与条形码工具</title>
  <!--script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script-->
  <script src="./qrcode.min.js"></script>
  <!--script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script-->
  <script src="./JsBarcode.all.min.js"></script>
  <!--script src="https://unpkg.com/@zxing/library@0.21.3"></script-->
  <script src="./zxing.min.js"></script>
  <!--script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script-->
  <script src="./jsQR.js"></script>
  

  <style>
    :root {
      color-scheme: light dark;
      --bg: #0b0c0f;
      --fg: #e7e9ee;
      --muted: #8a90a2;
      --card: #151822;
      --accent: #4da3ff;
      --ok: #27c281;
      --warn: #ffb020;
      --err: #ff5d5d;
      --border: #2a2f3a;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f7f8fb;
        --fg: #1d2129;
        --muted: #636a7b;
        --card: #ffffff;
        --accent: #246bff;
        --ok: #0aa770;
        --warn: #b87900;
        --err: #d13f3f;
        --border: #e5e7ef;
      }
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font: 15px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "PingFang SC", "Noto Sans CJK SC", "Microsoft YaHei UI", "Microsoft YaHei", sans-serif;
    }
    header {
      padding: 16px 16px 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      font-size: 20px;
      margin: 0;
    }
    .language-selector {
      display: flex;
      gap: 8px;
    }
    .language-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .language-btn.active {
      background: var(--accent);
      color: white;
      border-color: transparent;
    }
    header p {
      margin: 0;
      color: var(--muted);
      font-size: 13px;
    }
    main {
      padding: 12px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 16px;
    }
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 16px;
    }
    .tab {
      padding: 8px 16px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
    }
    .tab.active {
      border-bottom-color: var(--accent);
      color: var(--accent);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .section-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .section-title h2 {
      font-size: 16px;
      margin: 0;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin: 8px 0;  
    }
    .row > * {
      flex: none;
    }
    .field {
      display: grid;
      align-items: start;
      gap: 6px;
      margin: 8px 0;
    }
    label { color: var(--muted); font-size: 13px; }
    input[type="text"], input[type="number"], select, textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--fg);
      outline: none;
    }
    textarea { min-height: 80px; resize: vertical; }
    
    @keyframes highlight {
      0% { background-color: #b0ff38; }
      50% { background-color: #b0ff38; }
      100% { background-color: transparent; }
    }
    .highlight {
      animation: highlight 0.4s ease;
    }

    button, .btn {
      appearance: none;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--fg);
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
    }
    button.primary {
      background: var(--accent);
      border-color: transparent;
      color: #fff;
    }
    button.ok { background: var(--ok); color: #fff; border-color: transparent; }
    button.warn { background: var(--warn); color: #fff; border-color: transparent; }
    button.danger { background: var(--err); color: #fff; border-color: transparent; }
    button:disabled { opacity: .55; cursor: not-allowed; }
    .hint { color: var(--muted); font-size: 12px; }
    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      word-break: break-all;
      white-space: pre-wrap;
    }
    .flex {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .hr { height: 1px; background: var(--border); margin: 10px 0; }
    .grid {
      display: grid;
      gap: 8px;
    }
    .two { grid-template-columns: repeat(2, minmax(0,1fr)); }
    .three { grid-template-columns: repeat(3, minmax(0,1fr)); }
    .dropzone {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 14px;
      text-align: center;
      color: var(--muted);
    }
    .dropzone.dragover {
      border-color: var(--accent);
      color: var(--accent);
      background: color-mix(in oklab, var(--accent) 10%, transparent);
    }
    video, canvas, img {
      max-width: 100%;
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0002;
    }
    .split {
      display: grid;
      gap: 8px;
      grid-template-columns: 1fr 1fr;
    }
    .history-panel {
      margin-top: 16px;
      border-top: 1px solid var(--border);
      padding-top: 16px;
    }
    .history-item {
      padding: 8px;
      border-radius: 8px;
      background: color-mix(in oklab, var(--accent) 5%, transparent);
      margin-bottom: 8px;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .history-container {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px;
      margin-top: 8px;
    }
    .history-content {
      word-break: break-all;
      flex: 1;
    }
    .history-actions {
      display: flex;
      gap: 4px;
    }
    .history-btn {
      padding: 4px 8px;
      font-size: 12px;
    }
    @media (max-width: 768px) {
      .split { grid-template-columns: 1fr; }
    }
    .kbd {
      background: #0003;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 1px 6px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
    }
    .tag {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 12px;
      color: var(--muted);
    }
    .result-bad { color: var(--err); }
    .result-ok { color: var(--ok); }
    .copy-btn { font-size: 12px; padding: 6px 8px; }
    footer {
      padding: 8px 16px 24px;
      color: var(--muted);
      font-size: 12px;
      text-align: center;
    }
    .supported-formats {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 8px;
      margin-top: 12px;
    }
    .format-item {
      padding: 6px;
      border-radius: 8px;
      background: color-mix(in oklab, var(--accent) 10%, transparent);
      text-align: center;
      font-size: 12px;
    }
    .generate-preview {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }
    #codeCanvas {
      max-width: 100%;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      background: white;
    }
    .action-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      background: var(--ok);
      color: white;
      border-radius: 4px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transform: translateX(100%);
      transition: transform 0.3s ease-in-out;
      z-index: 1000;
    }
    .notification.show {
      transform: translateX(0);
    }
    .notification.error {
      background: var(--err);
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1 id="header-title">二维码与条形码工具</h1>
      <p id="header-desc">生成和扫描多种格式的二维码与条形码</p>
    </div>
    <div class="language-selector">
      <button class="language-btn active" data-lang="zh">中文</button>
      <button class="language-btn" data-lang="en">English</button>
    </div>
  </header>

  <main>
    <div class="tabs">
      <div class="tab active" data-tab="scan" id="tab-scan">扫描</div>
      <div class="tab" data-tab="generate" id="tab-generate">生成</div>
    </div>


    <!-- 扫描标签页 -->
    <div class="tab-content active" id="scan-tab">
      <div class="card" id="scan-card">
        <div class="section-title">
          <h2 id="scan-title">扫描</h2>
          <div class="flex">
            <span class="tag">ZXing + jsQR</span>
            <button id="btn-clear-scan" class="btn" id="btn-clear">清空结果</button>
          </div>
        </div>

        <div class="split">
          <div class="">
            <div class="field">
              <label id="label-input-source">选择输入来源</label>
              <div class="row">
                <button id="btn-camera" class="btn" id="btn-camera-text">摄像头</button>
                <button id="btn-screen" class="btn" id="btn-screen-text">屏幕共享</button>
              </div>
              <div class="dropzone" id="dropzone">
                <button id="btn-file" class="btn" id="btn-file-text">选择文件</button>
                <span id="dropzone-text">，或拖拽图片到此处，或按 Ctrl/⌘+V</span>
                <button id="btn-clipboard" id="btn-paste-text">粘贴图像</button>
              </div>
              <input type="file" id="file-input" accept="image/*" hidden="" multiple="">
            </div>
            <div class="field">
              <label id="label-scan-result">扫描结果（文本）</label>
              <textarea id="scan-text" class="mono" placeholder="结果文本"></textarea>
              <div class="row">
                <button class="btn copy-btn" data-copy="#scan-text" id="btn-copy-text">复制文本</button>
                <button class="btn copy-btn primary" id="btn-go-to" disabled>前往目标</button>
                <span id="format-tag" class="tag">Format Tag: -</span>
                <span id="symbology-tag" class="tag">Symbology: -</span>
              </div>
            </div>

            <div class="field">
              <label id="label-scan-hex">扫描结果（Hex）</label>
              <textarea id="scan-hex" class="mono" placeholder="十六进制（原始字节，如有）"></textarea>
              <div class="row">
                <button class="btn copy-btn" data-copy="#scan-hex" id="btn-copy-hex">复制 Hex</button>
                <span class="hint" id="label-encoding">编码: <span id="encoding-tag">未知/自动</span></span>
              </div>
            </div>

            <div class="history-panel">
              <div class="section-title">
                <h2 id="scan-history-title">扫描历史</h2>
                <button id="btn-clear-scan-history" class="btn danger">清空历史</button>
              </div>
              <div class="history-container"> 
                <div id="scan-history-list"></div>
              </div>
            </div>           
            
          </div>

          <div class="grid">
            
            <div class="">
              <div class="split">
                <div class="">
                  <label id="label-preview">实时预览</label>
                  <video id="video" playsinline="" muted=""></video>
                  
                  <div class="row">
                    <button id="btn-stop" class="btn danger" id="btn-stop-text" disabled>停止输入</button>
                    <span class="hint" id="stream-hint">未激活</span>
                  </div>
                </div>
                <div class="">
                  
                  <label id="label-latest-frame">最近一帧（用于文件/剪贴板/拖拽也会显示）</label>
                  <canvas id="canvas" width="32" height="24"></canvas>
                  <div class="row">
                    <button id="btn-copy-frame" class="btn" id="btn-copy-frame-text">复制图像</button>
                    <button id="btn-save-frame" class="btn" id="btn-save-frame-text">保存图像</button>
                    <span class="hint" id="label-right-click">右键另存为亦可</span>
                  </div>
                </div>
                

              </div>
              

              <div class="field">
                <label id="label-params">预处理与参数</label>
                <div class="row">
                  <label class="flex" title="对输入图像进行灰度 + 二值化，提升对比度" >
                    <input type="checkbox" id="chk-binarize"> 
                    <p id="label-binarize">二值化</p>
                  </label>
                  <label class="flex" title="自动旋转多角度尝试" >
                    <input type="checkbox" id="chk-rotate" checked="">
                    <p id="label-rotate">旋转尝试</p>
                  </label>
                  <label class="flex" title="高分辨率解码更准但更慢" id="label-max-size">最大边长:</label>
                  <input type="number" id="max-size" value="1600" min="256" max="4000" step="64" style="width:90px">px
                </div>
              </div>

              <div class="field">
                <label id="label-frame-rate">帧抓取频率（摄像头/屏幕）</label>
                <div class="row">
                  <input type="number" id="interval" value="300" min="60" step="20" style="width:120px">
                  <span class="hint" id="label-ms-per-frame">毫秒/帧（越小越快）</span>
                </div>
              </div>

              <div class="field">
                <label id="label-log">日志</label>
                <textarea id="log" class="mono" style="height:100px" readonly=""></textarea>
              </div>
            </div>

            <div class="field">

            </div>

          </div>
        </div>
        
        <div class="hr"></div>
        
        <div class="field">
          <label id="label-supported-formats">支持的格式</label>
          <div class="supported-formats">
            <div class="format-item">QR Code</div>
            <div class="format-item">Data Matrix</div>
            <div class="format-item">PDF417</div>
            <div class="format-item">Aztec</div>
            <div class="format-item">EAN-13</div>
            <div class="format-item">EAN-8</div>
            <div class="format-item">UPC A</div>
            <div class="format-item">Code 128</div>
            <div class="format-item">Code 93</div>
            <div class="format-item">Code 39</div>
          </div>
        </div>
      </div>
    </div>

    
    <!-- 生成标签页 -->
    <div class="tab-content" id="generate-tab">
      <div class="card">
        <div class="split">
          <div class="controls">
            <div class="field">
              <label for="codeType" id="label-code-type">码类型</label>
              <select id="codeType">
                <optgroup label="二维码 QR Code" id="optgroup-qr">
                  <option value="qrcode">QR Code</option>
                </optgroup>
                <optgroup label="条形码 Barcode" id="optgroup-barcode">
                  <option value="ean13">EAN-13</option>
                  <option value="ean8">EAN-8</option>
                  <option value="code128">Code 128</option>
                  <option value="code39">Code 39</option>
                </optgroup>
              </select>
            </div>
            
            <div class="field">
              <label for="content" id="label-content">内容</label>
              <textarea id="content" placeholder="请输入要编码的文本或URL"></textarea>
            </div>
            
            <div id="qrcodeOptions">
              <div class="field">
                <label for="qrcodeErrorCorrection" id="label-error-correction">纠错等级</label>
                <select id="qrcodeErrorCorrection">
                  <option value="L">L - 低 (7%)</option>
                  <option value="M" selected>M - 中 (15%)</option>
                  <option value="Q">Q - 四分 (25%)</option>
                  <option value="H">H - 高 (30%)</option>
                </select>
              </div>
              
              <div class="field">
                <label for="qrcodeVersion" id="label-qr-version">QR 版本 (1-40)</label>
                <input type="number" id="qrcodeVersion" min="1" max="40" value="0">
                <small id="label-auto-select">0 表示自动选择</small>
              </div>
            </div>
            
            <div id="barcodeOptions" style="display: none;">
              <div class="field">
                <label for="barcodeDisplayValue" id="label-display-text">显示文本</label>
                <select id="barcodeDisplayValue">
                  <option value="true" id="option-yes">是</option>
                  <option value="false" id="option-no">否</option>
                </select>
              </div>
            </div>
            
            <button id="generateBtn" class="primary" id="btn-generate">生成代码</button>
            
            <div class="history-panel">
              <div class="section-title">
                <h2 id="generate-history-title">生成历史</h2>
                <button id="btn-clear-generate-history" class="btn danger">清空历史</button>
              </div>
              <div class="history-container">
                <div id="generate-history-list"></div>
              </div>
            </div>
            
          </div>
          
          <div class="generate-preview">
            <canvas id="codeCanvas"></canvas>
            <div class="action-buttons">
              <button id="downloadBtn" class="btn" id="btn-download">下载图片</button>
              <button id="copyBtn" class="btn" id="btn-copy">复制图片</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer id="footer-text">
    本页仅在本地浏览器中运行。快捷键：粘贴图像 Ctrl/⌘+V。由 Github:SS2867 在 GPT-5、DeepSeek-R1 的协助下构建。
  </footer>

  <div class="notification" id="notification">操作成功！</div>

  <script>
    // 语言支持
    const translations = {
      zh: {
        // 标题和描述
        'header-title': '二维码与条形码工具',
        'header-desc': '生成和扫描多种格式的二维码与条形码',
        'tab-generate': '生成',
        'tab-scan': '扫描',
        'footer-text': '本页仅在本地浏览器中运行。快捷键：粘贴图像 Ctrl/⌘+V。由 Github:SS2867 在 GPT-5、DeepSeek-R1 的协助下构建。',
        
        
        // 生成页面
        'label-code-type': '码类型',
        'label-content': '内容',
        'label-error-correction': '纠错等级',
        'label-qr-version': 'QR 版本 (1-40)',
        'label-auto-select': '0 表示自动选择',
        'label-display-text': '显示文本',
        'option-yes': '是',
        'option-no': '否',
        'generateBtn': '生成代码',
        'downloadBtn': '下载图片',
        'copyBtn': '复制图片',
        'generate-history-title': '生成历史',
        'btn-clear-generate-history': "清空历史",
        
        // 扫描页面
        'scan-title': '扫描',
        'btn-clear-scan': '清空结果',
        'label-input-source': '选择输入来源',
        'btn-camera': '摄像头',
        'btn-screen': '屏幕共享',
        'btn-file': '选择文件',
        'dropzone-text': '，或拖拽图片到此处，或按 Ctrl/⌘+V',
        'btn-clipboard': '粘贴图像',
        'label-scan-result': '扫描结果（文本）',
        'btn-copy-text': '复制文本',
        "btn-go-to": '前往目标',
        'label-scan-hex': '扫描结果（Hex）',
        'btn-copy-hex': '复制 Hex',
        'label-encoding': '编码:',
        'label-log': '日志',
        'label-preview': '实时预览',
        'label-latest-frame': '最近一帧（用于文件/剪贴板/拖拽也会显示）',
        'btn-copy-frame': '复制图像',
        'btn-save-frame': '保存图像',
        'label-right-click': '右键另存为亦可',
        'btn-stop': '停止输入',
        'label-params': '预处理与参数',
        'label-binarize': '二值化',
        'label-rotate': '旋转尝试',
        'label-max-size': '最大边长:',
        'label-frame-rate': '帧抓取频率（摄像头/屏幕）',
        'label-ms-per-frame': '毫秒/帧（越小越快）',
        'label-supported-formats': '支持的格式',
        'scan-history-title': '扫描历史',
        'btn-clear-scan-history': "清空历史",
        
        // 通知消息
        'notification-success': '操作成功！',
        'notification-downloaded': '图片已下载',
        'notification-copied': '图片已复制到剪贴板',
        'notification-scan-result-copied': '内容已复制到剪贴板',
        'notification-copy-failed': '复制失败，请使用现代浏览器',
        'notification-empty-content': '请输入内容',
        'notification-generation-failed': '生成失败: ',
        'notification-qr-success': '二维码生成成功',
        'notification-barcode-success': '条形码生成成功'
      },
      en: {
        // 标题和描述
        'header-title': 'QR & Barcode Tool',
        'header-desc': 'Generate and scan multiple formats of QR codes and barcodes',
        'tab-generate': 'Generate',
        'tab-scan': 'Scan',
        'footer-text': 'This page runs only in the local browser. Created by Github:SS2867 with the assistance of GPT-5 and DeepSeek-R1.',
        
        // 生成页面
        'label-code-type': 'Code Type',
        'label-content': 'Content',
        'label-error-correction': 'Error Correction Level',
        'label-qr-version': 'QR Version (1-40)',
        'label-auto-select': '0 for auto selection',
        'label-display-text': 'Display Text',
        'option-yes': 'Yes',
        'option-no': 'No',
        'generateBtn': 'Generate Code',
        'downloadBtn': 'Download Image',
        'copyBtn': 'Copy Image',
        'generate-history-title': 'Generate History',
        'btn-clear-generate-history': "Clear History",
        
        // 扫描页面
        'scan-title': 'Scan',
        'btn-clear-scan': 'Clear Results',
        'label-input-source': 'Select Input Source',
        'btn-camera': 'Camera',
        'btn-screen': 'Screen Share',
        'btn-file': 'Select File',
        'dropzone-text': ', or drag and drop image here, or press Ctrl/⌘+V to',
        'btn-clipboard': 'Paste Image',
        'label-scan-result': 'Scan Result (Text)',
        'btn-copy-text': 'Copy Text',
        "btn-go-to": 'Go to URL',
        'label-scan-hex': 'Scan Result (Hex)',
        'btn-copy-hex': 'Copy Hex',
        'label-encoding': 'Encoding:',
        'label-log': 'Log',
        'label-preview': 'Live Preview',
        'label-latest-frame': 'Latest Frame (also shown for file/clipboard/drag)',
        'btn-copy-frame': 'Copy Image',
        'btn-save-frame': 'Save Image',
        'label-right-click': 'Or right-click and save as',
        'btn-stop': 'Stop Input',
        'label-params': 'Preprocessing & Parameters',
        'label-binarize': 'Binarize',
        'label-rotate': 'Rotation Attempt',
        'label-max-size': 'Max Side:',
        'label-frame-rate': 'Frame Rate (Camera/Screen)',
        'label-ms-per-frame': 'ms/frame (smaller is faster)',
        'label-supported-formats': 'Supported Formats',
        'scan-history-title': 'Scan History',
        'btn-clear-scan-history': "Clear History",
        
        // 通知消息
        'notification-success': 'Operation successful!',
        'notification-downloaded': 'Image downloaded',
        'notification-copied': 'Image copied to clipboard',
        'notification-scan-result-copied': 'Content copied to clipboard',
        'notification-copy-failed': 'Copy failed, please use a modern browser',
        'notification-empty-content': 'Please enter content',
        'notification-generation-failed': 'Generation failed: ',
        'notification-qr-success': 'QR code generated successfully',
        'notification-barcode-success': 'Barcode generated successfully'
      }
    };

    let currentLang = 'zh';

    function changeLanguage(lang) {
      currentLang = lang;
      
      // 更新语言按钮状态
      document.querySelectorAll('.language-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
      });
      
      // 更新所有文本内容
      Object.keys(translations[lang]).forEach(key => {
        const elements = document.querySelectorAll(`[id="${key}"]`);
        elements.forEach(el => {
          if (el.tagName === 'INPUT' && el.type === 'text') {
            el.placeholder = translations[lang][key];
          } else if (el.tagName === 'INPUT' && el.type !== 'text') {
            // 跳过非文本输入框和选择
          //} else if (el.tagName === "LABEL" && el.textContent===""){
          //  el.title = translations[lang][key];
          }
          else {
            el.textContent = translations[lang][key];
          }
        });
      });
    }

    // 初始化语言切换
    document.querySelectorAll('.language-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        changeLanguage(btn.dataset.lang);
      });
    });

    // 标签页切换
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        
        // 更新标签页状态
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // 更新内容显示
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        document.getElementById(`${tabName}-tab`).classList.add('active');
      });
    });

    // 生成代码功能
    document.addEventListener('DOMContentLoaded', function() {
      
      // 初始生成一个示例
      content.value = 'https://www.example.com';
      generateCode();
    });
    const codeType = document.getElementById('codeType');
    const content = document.getElementById('content');
    const qrcodeErrorCorrection = document.getElementById('qrcodeErrorCorrection');
    const qrcodeVersion = document.getElementById('qrcodeVersion');
    const barcodeDisplayValue = document.getElementById('barcodeDisplayValue');
    const generateBtn = document.getElementById('generateBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const copyBtn = document.getElementById('copyBtn');
    const codeCanvas = document.getElementById('codeCanvas');
    const notification = document.getElementById('notification');
    const qrcodeOptions = document.getElementById('qrcodeOptions');
    const barcodeOptions = document.getElementById('barcodeOptions');
    
    // 生成代码
    generateBtn.addEventListener('click', generateCode);
    
    // 下载图片
    downloadBtn.addEventListener('click', function() {
      const link = document.createElement('a');
      link.download = 'code.png';
      link.href = codeCanvas.toDataURL('image/png');
      link.click();
      showNotification(translations[currentLang]['notification-downloaded']);
    });
    
    // 复制图片到剪贴板
    copyBtn.addEventListener('click', function() {
      codeCanvas.toBlob(function(blob) {
        const item = new ClipboardItem({ 'image/png': blob });
        navigator.clipboard.write([item])
          .then(function() {
            showNotification(translations[currentLang]['notification-copied']);
          })
          .catch(function(error) {
            console.error('复制失败: ', error);
            showNotification(translations[currentLang]['notification-copy-failed'], true);
          });
      });
    });
    
    // 生成代码函数
    function generateCode() {
      if (!content.value.trim()) {
        showNotification(translations[currentLang]['notification-empty-content'], true);
        return;
      }
      
      const type = codeType.value;
      const ctx = codeCanvas.getContext('2d');
      
      // 清除画布
      ctx.clearRect(0, 0, codeCanvas.width, codeCanvas.height);
      
      try {
        if (type === 'qrcode') {

          const options = {
            errorCorrectionLevel: qrcodeErrorCorrection.value,
            version: parseInt(qrcodeVersion.value) || undefined,
            width: 300,
            margin: 1,
            color: {
              dark: '#000000',
              light: '#ffffff'
            }
          };

          // 生成二维码
          QRCode.toCanvas(codeCanvas, content.value,options, function(error) {
            if (error) {
              console.error(error);
              showNotification(translations[currentLang]['notification-generation-failed'] + error.message, true);
            } else {
              showNotification(translations[currentLang]['notification-qr-success']);
              saveGenerateHistory(type, content.value, {
                errorCorrectionLevel: options.errorCorrectionLevel,
                version: options.version
              });
            }
          });
        } else {

          const options = {
            format: type,
            displayValue: barcodeDisplayValue.value === 'true',
            width: 2,
            height: 100,
            margin: 10,
            background: '#ffffff',
            lineColor: '#000000'
          };

          // 生成条形码
          JsBarcode(codeCanvas, content.value, options);
          showNotification(translations[currentLang]['notification-barcode-success']);
          saveGenerateHistory(type, content.value, {
            displayValue: options.displayValue
          });
        }
      } catch (error) {
        console.error(error);
        showNotification(translations[currentLang]['notification-generation-failed'] + error.message, true);
      }
    }
    // 根据选择的码类型显示/隐藏选项
    function toggleGenerationOptions() {
      if (codeType.value === 'qrcode') {
        qrcodeOptions.style.display = 'block';
        barcodeOptions.style.display = 'none';
      } else {
        qrcodeOptions.style.display = 'none';
        barcodeOptions.style.display = 'block';
      }
    }
    codeType.addEventListener('change', toggleGenerationOptions);

    // 显示通知
    notificationHideTimeout = null;
      function showNotification(message, isError = false) {
        if(notificationHideTimeout){clearTimeout(notificationHideTimeout); notificationHideTimeout=null;}
        notification.textContent = message;
        notification.classList.toggle('error', isError);
        notification.classList.add('show');
        
        notificationHideTimeout = setTimeout(function() {
          notification.classList.remove('show'); notificationHideTimeout=null;
        }, 3000);
      }
    notification.addEventListener("click", ()=>{notification.classList.remove('show');});

    // 扫描功能
    // 简易日志
    const logEl = document.getElementById('log');
    function log(msg) {
      const time = new Date().toLocaleTimeString();
      logEl.value += `[${time}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    // 工具函数
    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

    function bytesToHex(uint8) {
      if (!uint8) return '';
      return Array.from(uint8, b => b.toString(16).padStart(2, '0')).join(' ');
    }
    function textToBytes(text, enc) {
      try {
        if (enc === 'iso-8859-1') {
          // 单字节映射
          const out = new Uint8Array(text.length);
          for (let i=0;i<text.length;i++) out[i] = text.charCodeAt(i) & 0xFF;
          return out;
        } else if (enc === 'shift_jis') {
          // 采用 TextEncoder 不支持，简单降级：用 Encoding API 若可用
          if ('TextEncoder' in window && 'encoding' in TextEncoder.prototype) {
            return new TextEncoder('shift_jis').encode(text);
          }
          // 简化降级：转 UTF-8
          return new TextEncoder().encode(text);
        } else if (enc === 'ascii') {
          const out = new Uint8Array(text.length);
          for (let i=0;i<text.length;i++) out[i] = text.charCodeAt(i) & 0x7F;
          return out;
        } else {
          return new TextEncoder().encode(text);
        }
      } catch(e) {
        log('编码失败，使用 UTF-8：' + e);
        return new TextEncoder().encode(text);
      }
    }
    function bytesToText(uint8, encHint) {
      try {
        if (encHint && encHint.toLowerCase().includes('shift') && 'TextDecoder' in window) {
          return new TextDecoder('shift_jis', {fatal:false}).decode(uint8);
        }
        if (encHint && encHint.toLowerCase().includes('iso')) {
          return Array.from(uint8, b => String.fromCharCode(b)).join('');
        }
        return new TextDecoder().decode(uint8);
      } catch {
        // 回退 Latin-1
        return Array.from(uint8, b => String.fromCharCode(b)).join('');
      }
    }
    function autoDecodeRaw(rawBytes) {
      // 尝试 UTF-8，否则 Latin-1
      try {
        return { text: new TextDecoder('utf-8', {fatal:true}).decode(rawBytes), encoding: 'UTF-8' };
      } catch {
        return { text: Array.from(rawBytes, b => String.fromCharCode(b)).join(''), encoding: 'ISO-8859-1 (assumed)' };
      }
    }
    async function copyText(sel) {
      const el = typeof sel === 'string' ? document.querySelector(sel) : sel;
      if (!el) return;
      const text = el.value ?? el.textContent ?? '';
      await navigator.clipboard.writeText(text);
      toast(translations[currentLang]['notification-scan-result-copied'], 0);
    }
    async function copyCanvas(canvas) {
      try {
        if (canvas.toBlob && navigator.clipboard?.write) {
          const blob = await new Promise(r => canvas.toBlob(r));
          await navigator.clipboard.write([new ClipboardItem({ [blob.type]: blob })]);
          toast(translations[currentLang]['notification-copied'], 0);
        } else {
          toast(translations[currentLang]['notification-copy-failed'], true);
        }
      } catch (e) {
        console.error(e);
        toast('复制图像失败', true);
      }
    }
    function saveCanvas(canvas, name = 'frame.png') {
      const link = document.createElement('a');
      link.download = name;
      link.href = canvas.toDataURL('image/png');
      link.click();
    }
    notificationHideTimeout = null;
    toast = showNotification;
    function toast(msg, isError) {
      if(notificationHideTimeout){clearTimeout(notificationHideTimeout); notificationHideTimeout=null;}
      const el = document.getElementById('notification');
      el.textContent = msg;
      el.classList.toggle('error', isError);
      el.classList.add('show');
      notificationHideTimeout = setTimeout(() => {el.classList.remove('show');notificationHideTimeout=null;}, 3000);
    }
    

    // 扫描器
    const videoEl = document.getElementById('video');
    const canvasEl = document.getElementById('canvas');
    const ctx = canvasEl.getContext('2d');
    const scanTextEl = document.getElementById('scan-text');
    const scanHexEl = document.getElementById('scan-hex');
    const formatTagEl = document.getElementById('format-tag');
    const symbologyTagEl = document.getElementById('symbology-tag');
    const encodingTagEl = document.getElementById('encoding-tag');
    const dropzoneEl = document.getElementById('dropzone');
    const fileInputEl = document.getElementById('file-input');
    const streamHintEl = document.querySelector('#stream-hint');
    const chkBinarize = document.getElementById('chk-binarize');
    const chkRotate = document.getElementById('chk-rotate');
    const maxSizeEl = document.getElementById('max-size');
    const intervalEl = document.getElementById('interval');

    let stream = null;
    let intervalId = null;
    let zxingReader = null;
    let jsQRDetector = null;

    // 初始化
    async function init() {
      try {
        const hints = new Map();
        // 设置尝试多种格式
        const formats = [
          ZXing.BarcodeFormat.QR_CODE,
          ZXing.BarcodeFormat.DATA_MATRIX,
          ZXing.BarcodeFormat.PDF_417,
          ZXing.BarcodeFormat.AZTEC,
          ZXing.BarcodeFormat.EAN_13,
          ZXing.BarcodeFormat.EAN_8,
          ZXing.BarcodeFormat.UPC_A,
          ZXing.BarcodeFormat.UPC_E,
          ZXing.BarcodeFormat.CODE_128,
          ZXing.BarcodeFormat.CODE_93,
          ZXing.BarcodeFormat.CODE_39,
          ZXing.BarcodeFormat.CODABAR,
          ZXing.BarcodeFormat.ITF,
        ];
        hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, formats);
        hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
        zxingReader = new ZXing.BrowserMultiFormatReader(hints);
        log('ZXing 初始化完成，支持多种格式，ZXing 版本：' + ZXing.version);
      }catch{
        zxingReader = new ZXing.BrowserMultiFormatReader();
        log('ZXing 初始化完成，ZXing 版本：' + ZXing.version);
      }
      
      jsQRDetector = new ZXing.BrowserQRCodeReader();
      log('jsQRDetector 初始化完成');
      
      
      // 监听粘贴事件
      document.addEventListener('paste', handlePaste);
      
      // 监听拖拽事件
      const dropzone = document.getElementById('dropzone');
      ;['dragenter','dragover'].forEach(ev => dropzone.addEventListener(ev, e => {
        e.preventDefault();
        dropzone.classList.add('dragover');
      }));
      ;['dragleave','drop'].forEach(ev => dropzone.addEventListener(ev, e => {
        e.preventDefault();
        if (ev === 'drop') {
          const dt = e.dataTransfer;
          const files = Array.from(dt.files || []);
          if (files.length) {
            files.forEach(handleFile);
          } else {
            // 可能是网页图片
            const url = dt.getData('text/uri-list') || dt.getData('text/plain');
            if (url) {
              const img = new Image();
              img.crossOrigin = 'anonymous';
              img.onload = async () => {
                const ok = await processImageSource(img, true);
                log((ok ? '识别成功：' : '未识别：') + '外部图片');
                stopStream();
              };
              img.onerror = () => log('加载外部图片失败');
              img.src = url;
            }
          }
        }
        dropzone.classList.remove('dragover');
      }));
      // dropzone.addEventListener('drop', e => {
      //   e.preventDefault();
      //   dropzone.classList.remove('dragover');
      //   const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
      //   if (files.length) handleFile(files);
      // });
      
      // 按钮事件
      document.getElementById('btn-camera').addEventListener('click', startCamera);
      document.getElementById('btn-screen').addEventListener('click', startScreen);
      document.getElementById('btn-file').addEventListener('click', () => document.getElementById('file-input').click());
      document.getElementById('btn-clipboard').addEventListener('click', async () => {
        try {
          const items = await navigator.clipboard.read();
          for (const item of items) {
            for (const type of item.types) {
              if (type.startsWith('image/')) {
                const blob = await item.getType(type);
                await handleFile(new File([blob], 'clipboard.' + type.split('/')[1], { type }));
                return;
              }
            }
          }
          toast('剪贴板中未发现图片', 1);
        } catch (e) {
          log('读取剪贴板失败：' + e);
          toast('请尝试使用 Ctrl/⌘+V 粘贴', 1);
        }
      });
      document.getElementById('btn-go-to').addEventListener('click', () => {
        let t = scanTextEl.value.trim(); try{new URL(t);}catch{t=((isValidURL(t)==1?'http://':'mailto:')+t);};
        window.open(t, "_blank");});
      document.getElementById('btn-stop').addEventListener('click', stopStream);
      document.getElementById('btn-clear-scan').addEventListener('click', clearResults);
      document.getElementById('btn-copy-frame').addEventListener('click', () => copyCanvas(canvasEl));
      document.getElementById('btn-save-frame').addEventListener('click', () => saveCanvas(canvasEl));
      document.querySelectorAll('[data-copy]').forEach(btn => {
        btn.addEventListener('click', () => copyText(btn.dataset.copy));
      });
      
      renderGenerateHistory();
      renderScanHistory();
    }

    // 处理粘贴事件
    async function handlePaste(ev) {
      const items = ev.clipboardData?.items || [];
      for (const item of items) {
        if (item.type.startsWith('image/')) {
          const file = item.getAsFile();
          stopStream();
          await handleFile(file);
          ev.preventDefault();
          return;
        }
      }
      // 若无 image，尝试读取文本为 Data URL
      const text = ev.clipboardData?.getData('text');
      if (text && /^data:image\//i.test(text)) {
        const img = new Image();
        img.onload = async () => {
          const ok = await processImageSource(img, true);
          log((ok ? '识别成功：' : '未识别：') + '剪贴板 DataURL');
        };
        img.onerror = () => log('解析剪贴板 DataURL 失败');
        img.src = text;
        ev.preventDefault();
      }
    }

    fileInputEl.addEventListener('change', async e => {
      const files = Array.from(e.target.files || []);
      for (const f of files) {
        await handleFile(f);
        stopStream();
      }
    });
    // 处理文件
    async function handleFile(file) {
      if (!file || !file.type.startsWith('image/')) { log('文件不是图片：' + (file?.name || '')); return; }
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = async () => {
        const ok = await processImageSource(img, true);
        log((ok ? '识别成功：' : '未识别：') + (file.name || '图片'));
        URL.revokeObjectURL(url);
      };
      img.onerror = () => { log('加载图片失败：' + (file.name || '')); URL.revokeObjectURL(url); };
      img.src = url;
    }

    // 开始摄像头
    async function startCamera() {
      try {
        stopStream();
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
        videoEl.srcObject = stream;
        await video.play();
        document.getElementById('btn-stop').removeAttribute("disabled");
        streamHintEl.textContent = '摄像头已开启';
        toast('摄像头已开启', 0);
        // 定时抓帧
        scanTimer = setInterval(async () => {
          await processImageSource(video, false);
        }, Math.max(60, parseInt(intervalEl.value,10)||300));
      } catch (e) {
        log('摄像头错误：' + e.message);
        toast('无法访问摄像头', 1);
      }
    }

    // 开始屏幕共享
    async function startScreen() {
      try {
        stopStream();
        stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: false });
        videoEl.srcObject = stream;
        await video.play();
        document.getElementById('btn-stop').removeAttribute("disabled");
        streamHintEl.textContent = '屏幕共享中';
        scanTimer = setInterval(async () => {
          await processImageSource(video, false);
        }, Math.max(60, parseInt(intervalEl.value,10)||300));
      } catch (e) {
        log('屏幕共享错误：' + e.message);
      }
    }

    // 停止流
    function stopStream() {
      if (intervalId) {
        clearInterval(intervalId);
        intervalId = null;
      }
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
        videoEl.srcObject = null;
        streamHintEl.textContent = '未激活';
      }
      document.getElementById('btn-stop').setAttribute("disabled", "");
    }

    // 开始扫描
    function startScanning() {
      if (intervalId) clearInterval(intervalId);
      intervalId = setInterval(captureAndScan, parseInt(intervalEl.value));
    }

    // 捕获并扫描
    // async function captureAndScan() {
    //   if (videoEl.readyState < 2) return;
      
    //   // 调整画布大小
    //   canvasEl.width = videoEl.videoWidth;
    //   canvasEl.height = videoEl.videoHeight;
      
    //   // 绘制帧
    //   ctx.drawImage(videoEl, 0, 0, canvasEl.width, canvasEl.height);
      
    //   // 扫描
    //   await scanCanvas(canvasEl);
    // }

    async function processImageSource(imgLike, rotateTry) {
      const maxSide = parseInt(maxSizeEl.value, 10) || 1600;
      const bin = chkBinarize.checked;
      const doRotate = chkRotate.checked && rotateTry;

      const angles = doRotate ? [0, 90, 180, 270] : [0];
      for (const a of angles) {
        if (!preprocessToCanvas(imgLike, maxSide, bin, a)) return false;
        const ok = await tryDecodeCurrentFrame();
        if (ok) return true;
      }
      return false;
    }

    function decodeWithJsQR() {
      try {
        const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const q = jsQR(imgData.data, imgData.width, imgData.height, { inversionAttempts: 'dontInvert' });
        if (q && q.data) {
          return { text: q.data, format: 'QR_CODE', rawBytes: null, symbology: 'QR Code' };
        }
      } catch {}
      return null;
    }

    async function tryDecodeCurrentFrame() {
      let result = await decodeFromCanvas();
      if (result) {
        let rawBytes = result.getRawBytes ? result.getRawBytes() : null;
        let text = result.getText ? result.getText() : (result.text || '');
        // ZXing 若含结构化编码字节可从 rawBytes 推断
        let encoding = '未知';
        if ((!text || /[\uFFFD]/.test(text)) && rawBytes) {
          const dec = autoDecodeRaw(rawBytes);
          text = dec.text;
          encoding = dec.encoding;
        } else if (rawBytes) {
          encoding = '由解码器提供/猜测';
        }
        showResult({
          text,
          rawBytes,
          format: result.getBarcodeFormat ? String(result.getBarcodeFormat()) : (result.format || ''),
          symbology: result.getBarcodeFormat ? result.getBarcodeFormat().toString().replace(/_/g, ' ') : '',
          encoding
        });
        return true;
      }
      // 兜底：仅 QR
      const q = decodeWithJsQR();
      if (q) {
        showResult({ text: q.text, rawBytes: null, format: q.format, symbology: 'QR Code', encoding: 'N/A' });
        return true;
      }
      return false;
    }


    function showResult({ text, rawBytes, format, symbology, encoding }) {
      const previousText = scanTextEl.value

      scanTextEl.value = text ?? '';
      scanHexEl.value = rawBytes ? bytesToHex(rawBytes) : '';
      formatTagEl.textContent = "Format Tag: " + (format || '-');
      symbologyTagEl.textContent = "Symbology: " + (symbology || '-');
      encodingTagEl.textContent = encoding || (rawBytes ? '自动检测' : '无');
      
      if (isValidURL(text)){
        document.getElementById('btn-go-to').removeAttribute("disabled");
      }else{
        document.getElementById('btn-go-to').setAttribute("disabled", "");
      }

      if (previousText !== (text ?? '')) {
        scanTextEl.classList.remove('highlight');
        void scanTextEl.offsetWidth;
        scanTextEl.classList.add('highlight');
        
        saveScanHistory({ text, rawBytes, format, symbology, encoding });
      }
    }

    function preprocessToCanvas(img, maxSide, binarize, rotateStepDeg = 0) {
      const iw = img.videoWidth || img.naturalWidth || img.width;
      const ih = img.videoHeight || img.naturalHeight || img.height;
      if (!iw || !ih) return false;

      const scale = Math.min(1, maxSide / Math.max(iw, ih));
      const w = Math.round(iw * scale);
      const h = Math.round(ih * scale);

      if (rotateStepDeg) {
        // 旋转画布尺寸调整
        const rad = rotateStepDeg * Math.PI / 180;
        const sin = Math.abs(Math.sin(rad)), cos = Math.abs(Math.cos(rad));
        canvasEl.width = Math.round(w * cos + h * sin);
        canvasEl.height = Math.round(w * sin + h * cos);
        ctx.save();
        ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);
        ctx.translate(canvasEl.width/2, canvasEl.height/2);
        ctx.rotate(rad);
        ctx.drawImage(img, -w/2, -h/2, w, h);
        ctx.restore();
      } else {
        canvasEl.width = w; canvasEl.height = h;
        ctx.clearRect(0, 0, w, h);
        ctx.drawImage(img, 0, 0, w, h);
      }

      if (binarize) {
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        // 灰度 + Otsu 简化（快速阈值：均值）
        let sum = 0;
        for (let i = 0; i < data.length; i += 4) {
          const g = (data[i]*0.299 + data[i+1]*0.587 + data[i+2]*0.114) | 0;
          data[i] = data[i+1] = data[i+2] = g;
          sum += g;
        }
        const mean = sum / (data.length/4);
        const thr = mean;
        for (let i = 0; i < data.length; i += 4) {
          const v = data[i] > thr ? 255 : 0;
          data[i] = data[i+1] = data[i+2] = v;
        }
        ctx.putImageData(imageData, 0, 0);
      }
      return true;
    }
    async function decodeFromCanvas() {
      if (!zxingReader) return null;
      try {
        const luminanceSource = new ZXing.HTMLCanvasElementLuminanceSource(canvasEl);
        const binarizer = new ZXing.GlobalHistogramBinarizer(luminanceSource);
        const bitmap = new ZXing.BinaryBitmap(binarizer);
        const result = zxingReader.decodeBitmap(bitmap);
        return result;
      } catch (e) {
        return null;
      }
    }
    

    // 扫描画布
    // async function scanCanvas(canvas) {
    //   const maxSize = parseInt(maxSizeEl.value);
    //   let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      
    //   // 调整大小以提高性能
    //   if (Math.max(imageData.width, imageData.height) > maxSize) {
    //     const scale = maxSize / Math.max(imageData.width, imageData.height);
    //     const smallCanvas = document.createElement('canvas');
    //     smallCanvas.width = Math.floor(imageData.width * scale);
    //     smallCanvas.height = Math.floor(imageData.height * scale);
    //     const smallCtx = smallCanvas.getContext('2d');
    //     smallCtx.drawImage(canvas, 0, 0, smallCanvas.width, smallCanvas.height);
    //     imageData = smallCtx.getImageData(0, 0, smallCanvas.width, smallCanvas.height);
    //   }
      
    //   // 二值化
    //   if (chkBinarize.checked) {
    //     const data = imageData.data;
    //     for (let i = 0; i < data.length; i += 4) {
    //       const avg = (data[i] + data[i+1] + data[i+2]) / 3;
    //       const val = avg > 128 ? 255 : 0;
    //       data[i] = data[i+1] = data[i+2] = val;
    //     }
    //   }
      
    //   // 使用 ZXing 扫描
    //   try {
    //     const result = await zxingReader.decodeFromImageData(imageData);
    //     if (result) {
    //       handleScanResult(result);
    //       return;
    //     }
    //   } catch (e) {
    //     // 忽略错误，继续尝试 jsQR
    //   }
      
    //   // 使用 jsQR 扫描（仅二维码）
    //   try {
    //     const code = jsQR(imageData.data, imageData.width, imageData.height, {
    //       inversionAttempts: 'dontInvert',
    //     });
        
    //     if (code) {
    //       handleScanResult({
    //         text: code.data,
    //         rawBytes: textToBytes(code.data),
    //         format: 'QR_CODE'
    //       });
    //       return;
    //     }
    //   } catch (e) {
    //     // 忽略错误
    //   }
    // }

    // 处理扫描结果
    // function handleScanResult(result) {
    //   scanTextEl.value = result.text;
      
    //   console.log(isValidURL(result.text));
    //   if (isValidURL(result.text)){
    //     document.getElementById('btn-go-to').removeAttribute("disabled");
    //   }else{
    //     document.getElementById('btn-go-to').setAttribute("disabled", "");
    //   }

    //   formatTagEl.textContent = `Format: ${result.format || 'QR_CODE'}`;
    //   symbologyTagEl.textContent = `Symbology: ${result.format || 'QR_CODE'}`;
      
    //   // 处理原始字节
    //   if (result.rawBytes) {
    //     const hex = bytesToHex(result.rawBytes);
    //     scanHexEl.value = hex;
        
    //     // 尝试自动解码
    //     const decoded = autoDecodeRaw(result.rawBytes);
    //     encodingTagEl.textContent = decoded.encoding;
    //   } else {
    //     scanHexEl.value = '';
    //     encodingTagEl.textContent = '文本';
    //   }
      
    //   log(`检测到: ${result.format}，内容: ${result.text.substring(0, 100)}${result.text.length > 100 ? '...' : ''}`);
    // }

    function isValidURL(string) {
      string = string.trim()
      
      const urlPattern = new RegExp(
        "^(https?:\\/\\/)?" + // 协议
          "((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|" + // 域名
          "((\\d{1,3}\\.){3}\\d{1,3}))" + // IP地址
          "(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*" + // 端口和路径
          "(\\?[;&a-zA-Z\\d%_.~+=-]*)?" + // 查询字符串
          "(\\#[;&a-zA-Z\\d%_.~+=-]*)?$",
        "i"
      ); // 碎片标识
      if (urlPattern.test(string)){return 1;}
      const emailPattern = /^(mailto:)?[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailPattern.test(string)? 2: 0;
      
    }

    let scanHistory = JSON.parse(localStorage.getItem('scanHistory') || '[]');
    let generateHistory = JSON.parse(localStorage.getItem('generateHistory') || '[]');

    // 保存扫描历史
    function saveScanHistory(result) {
      // 检查是否已存在相同内容的历史记录
      const exists = scanHistory.some(item => 
        item.text === result.text && 
        (!result.rawBytes || item.hex === bytesToHex(result.rawBytes))
      );
      
      if (!exists) {
        const historyItem = {
          text: result.text,
          hex: result.rawBytes ? bytesToHex(result.rawBytes) : '',
          format: result.format || '',
          symbology: result.symbology || '',
          encoding: result.encoding || '',
          timestamp: new Date().toISOString()
        };
        
        scanHistory.unshift(historyItem);
        // 限制历史记录数量（最多50条）
        if (scanHistory.length > 50) {
          scanHistory = scanHistory.slice(0, 50);
        }
        
        localStorage.setItem('scanHistory', JSON.stringify(scanHistory));
        renderScanHistory();
      }
    }

    function saveGenerateHistory(type, content, options = {}) {
      // 检查是否已存在相同内容的历史记录
      const exists = generateHistory.some(item => 
        item.type === type && 
        item.content === content &&
        JSON.stringify(item.options) === JSON.stringify(options)
      );
      
      if (!exists) {
        const historyItem = {
          type,
          content,
          options,
          timestamp: new Date().toISOString()
        };
        
        generateHistory.unshift(historyItem);
        // 限制历史记录数量（最多20条）
        if (generateHistory.length > 20) {
          generateHistory = generateHistory.slice(0, 20);
        }
        
        localStorage.setItem('generateHistory', JSON.stringify(generateHistory));
        renderGenerateHistory();
      }
    }

    // 渲染扫描历史
    function renderScanHistory() {
      const container = document.getElementById('scan-history-list');
      container.innerHTML = '';
      
      scanHistory.forEach((item, index) => {
        const historyItem = document.createElement('div');
        historyItem.className = 'history-item';
        
        const content = document.createElement('div');
        content.className = 'history-content';
        content.textContent = item.text.replaceAll('\n', "\\n") || '(无文本内容)';
        if(content.textContent.length>47){
          content.textContent = content.textContent.slice(0,47)+'...'}
        
        const actions = document.createElement('div');
        actions.className = 'history-actions';
        
        const copyBtn = document.createElement('button');
        copyBtn.className = 'btn history-btn';
        copyBtn.textContent = '📋';
        copyBtn.onclick = () => {
          navigator.clipboard.writeText(item.text);
          toast('已复制到剪贴板');
        };
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn history-btn danger';
        deleteBtn.textContent = '✕';
        deleteBtn.onclick = () => {
          scanHistory.splice(index, 1);
          localStorage.setItem('scanHistory', JSON.stringify(scanHistory));
          renderScanHistory();
        };
        
        actions.appendChild(copyBtn);
        actions.appendChild(deleteBtn);
        
        historyItem.appendChild(content);
        historyItem.appendChild(actions);
        
        container.appendChild(historyItem);
      });
    }

    // 渲染生成历史
    function renderGenerateHistory() {
      const container = document.getElementById('generate-history-list');
      container.innerHTML = '';
      
      generateHistory.forEach((item, index) => {
        const historyItem = document.createElement('div');
        historyItem.className = 'history-item';
        
        const content = document.createElement('div');
        content.className = 'history-content';
        content.textContent = item.content.replaceAll("\n", "\\n");
        if(content.textContent.length>47){
          content.textContent = content.textContent.slice(0,47)+'...'}
        
        const actions = document.createElement('div');
        actions.className = 'history-actions';
        
        const regenerateBtn = document.createElement('button');
        regenerateBtn.className = 'btn history-btn primary';
        regenerateBtn.textContent = '🔄️';
        regenerateBtn.onclick = () => {
          document.getElementById('codeType').value = item.type;
          document.getElementById('content').value = item.content;
          
          // 设置特定选项
          if (item.type === 'qrcode') {
            document.getElementById('qrcodeErrorCorrection').value = item.options.errorCorrectionLevel || 'M';
            document.getElementById('qrcodeVersion').value = item.options.version || 0;
          } else {
            document.getElementById('barcodeDisplayValue').value = item.options.displayValue !== false;
          }
          toggleGenerationOptions();
          
          generateCode();
          // 切换到生成标签页
          document.querySelector('[data-tab="generate"]').click();
        };
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn history-btn danger';
        deleteBtn.textContent = '✕';
        deleteBtn.onclick = () => {
          generateHistory.splice(index, 1);
          localStorage.setItem('generateHistory', JSON.stringify(generateHistory));
          renderGenerateHistory();
        };
        
        actions.appendChild(regenerateBtn);
        actions.appendChild(deleteBtn);
        
        historyItem.appendChild(content);
        historyItem.appendChild(actions);
        
        container.appendChild(historyItem);
      });
    }

    document.getElementById('btn-clear-scan-history').addEventListener('click', () => {
      scanHistory = [];
      localStorage.setItem('scanHistory', JSON.stringify(scanHistory));
      renderScanHistory();
      
    });

    document.getElementById('btn-clear-generate-history').addEventListener('click', () => {
      generateHistory = [];
      localStorage.setItem('generateHistory', JSON.stringify(generateHistory));
      renderGenerateHistory();
    });
    // 扫描图像
    // async function scanImage(img) {
    //   canvasEl.width = img.width;
    //   canvasEl.height = img.height;
    //   ctx.drawImage(img, 0, 0);
    //   await scanCanvas(canvasEl);
    // }

    // 清空结果
    function clearResults() {
      scanTextEl.value = '';
      scanHexEl.value = '';
      formatTagEl.textContent = 'Format Tag: -';
      symbologyTagEl.textContent = 'Symbology: -';
      encodingTagEl.textContent = '未知/自动';
      log('结果已清空');
    }

    // 初始化应用
    init();
  </script>
</body>
</html>